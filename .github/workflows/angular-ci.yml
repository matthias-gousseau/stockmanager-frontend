name: Angular CI/CD

on:
  push:
    branches: ['dev', 'main']
  pull_request:
    branches: ['dev', 'main']

jobs:
  # Job de tests - s'exÃ©cute sur les PR ET les push
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Run tests
        run: npm test -- --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # Job de build et dÃ©ploiement - s'exÃ©cute UNIQUEMENT sur push (aprÃ¨s merge)
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    env:
      ANGULAR_CONFIG: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
      DOCKERFILE: ${{ github.ref == 'refs/heads/main' && 'Dockerfile.prod' || 'Dockerfile.dev' }}
      DOCKER_TAG: ${{ github.ref == 'refs/heads/main' && 'latest' || 'dev' }}
      ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # - name: Setup Node
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '22'
      #     cache: 'npm'

      # - name: Install dependencies
      #   run: npm ci

      # - name: Build Angular
      #   run: npm run build -- --configuration=${{ env.ANGULAR_CONFIG }}

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: |
          docker build \
            -f ${{ env.DOCKERFILE }} \
            -t ghcr.io/matthias-gousseau/stockmanager-frontend:${{ env.DOCKER_TAG }} \
            -t ghcr.io/matthias-gousseau/stockmanager-frontend:${{ github.sha }} \
            .

      - name: Push Docker image
        run: |
          docker push ghcr.io/matthias-gousseau/stockmanager-frontend:${{ env.DOCKER_TAG }}
          docker push ghcr.io/matthias-gousseau/stockmanager-frontend:${{ github.sha }}

      # DÃ©ploiement selon la branche
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd stockmanager
            COMPOSE_FILE="${{ github.ref == 'refs/heads/main' && 'docker-compose.prod.yml' || 'docker-compose.dev.yml' }}"
            SERVICE="${{ github.ref == 'refs/heads/main' && 'frontend-prod' || 'frontend-dev' }}"
            echo "ðŸš€ DÃ©ploiement sur ${{ env.ENVIRONMENT }} avec $COMPOSE_FILE - $(date)"
            docker compose -f $COMPOSE_FILE pull $SERVICE
            docker compose -f $COMPOSE_FILE up -d --no-deps $SERVICE
            echo "âœ… DÃ©ploiement terminÃ©"
            docker ps --filter "name=stockmanager" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      # VÃ©rification du dÃ©ploiement
      - name: Verify deployment
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd stockmanager
            COMPOSE_FILE="${{ github.ref == 'refs/heads/main' && 'docker-compose.prod.yml' || 'docker-compose.dev.yml' }}"
            # Attendre que le conteneur soit complÃ¨tement dÃ©marrÃ©
            sleep 10

            # VÃ©rifier que le conteneur tourne
            if ! docker compose -f $COMPOSE_FILE ps | grep -q "Up"; then
              echo "âŒ ERREUR: Le conteneur n'est pas en cours d'exÃ©cution"
              docker compose -f $COMPOSE_FILE logs --tail=50
              exit 1
            fi

            echo "âœ… Conteneurs en cours d'exÃ©cution"
            docker compose -f $COMPOSE_FILE ps

      # Notification de succÃ¨s
      - name: Deployment summary
        run: |
          echo "### ðŸš€ DÃ©ploiement rÃ©ussi" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branche**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Docker**: ghcr.io/matthias-gousseau/stockmanager-frontend:${{ env.DOCKER_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # En cas d'Ã©chec du dÃ©ploiement
      - name: Deployment failed
        if: failure()
        run: |
          echo "### âŒ Ã‰chec du dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Le dÃ©ploiement sur ${{ env.ENVIRONMENT }} a Ã©chouÃ©." >> $GITHUB_STEP_SUMMARY
          echo "Consultez les logs pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
